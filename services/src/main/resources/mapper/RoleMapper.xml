<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.maoding.User.Dao.RoleDao">

    <resultMap id="TaskRoleMap" type="com.maoding.User.zeroc.TaskRoleDTO">
        <result property="id" column="task_id"/>
        <result property="name" column="task_name"/>
        <collection property="taskRoleList" ofType="com.maoding.Common.zeroc.IdNameDTO">
            <result property="id" column="task_role_id"/>
            <result property="name" column="task_role_name"/>
        </collection>
    </resultMap>

    <resultMap id="ProjectRoleMap" type="com.maoding.User.zeroc.ProjectRoleDTO" autoMapping="true">
        <collection property="projectRoleList" ofType="com.maoding.Common.zeroc.IdNameDTO">
            <result property="id" column="project_role_id"/>
            <result property="name" column="project_role_name"/>
        </collection>
        <collection property="taskList" resultMap="TaskRoleMap"/>
    </resultMap>

    <select id="listProjectRoleByProjectId" resultMap="ProjectRoleMap" parameterType="java.util.Map">
        select role.*
            ,if(role.type_id in (1,2,3),role.id,null) as project_role_id
            ,if(role.type_id in (1,2,3),role.type_name,null) as project_role_name
            ,if(role.type_id in (4,5,6,7),role.id,null) as task_role_id
            ,if(role.type_id in (4,5,6,7),role.type_name,null) as task_role_name
        from maoding_role role
        <where>
            <if test="projectId != null">
                and role.project_id = #{projectId}
            </if>
        </where>
        group by role.user_id,role.task_id
    </select>

    <select id="listProject" resultType="com.maoding.Common.zeroc.IdNameDTO" parameterType="java.util.Map">
        select distinct role.project_id as id, role.project_name as name from maoding_role role
        <where>
            role.project_id is not null
            <if test="userId != null">
                and role.user_id = #{userId}
            </if>
        </where>
    </select>
    <select id="listTask" resultType="com.maoding.Common.zeroc.IdNameDTO" parameterType="java.util.Map">
        select distinct role.task_id as id, role.task_name as name from maoding_role role
        <where>
            role.task_id is not null
            <if test="userId != null">
                and role.user_id = #{userId}
            </if>
        </where>
    </select>
    <select id="listCompany" resultType="com.maoding.Common.zeroc.IdNameDTO" parameterType="java.util.Map">
        select distinct role.company_id as id, role.company_name as name from maoding_role role
        <where>
            role.company_id is not null
            <if test="userId != null">
                and role.user_id = #{userId}
            </if>
        </where>
    </select>

    <select id="listMember" resultType="com.maoding.Common.zeroc.IdNameDTO" parameterType="com.maoding.User.zeroc.QueryMemberDTO">
        select distinct role.user_id as id, role.user_name as name from maoding_role role
        <where>
            <if test="userTypeIdString != null">
                and (role.type_id in (#{userTypeIdString}))
            </if>
            <if test="projectId != null">
                and (role.project_id = #{projectId})
            </if>
            <if test="taskId != null">
                and (role.task_id = #{taskId})
            </if>
            <if test="companyId != null">
                and (role.company_id = #{companyId})
            </if>
        </where>
    </select>
</mapper>
